# Azure DevOps pipeline template used to checkout, install node dependencies and build the code. 
#
# Note. The dependencies include packages from GitHub package registry that can be downloaded by  
#Â configuring the .npmrc file and setting the following pipeline variable with a personal access 
# token (with scope read:packages):
# GITHUB_TOKEN

parameters:
- name: 'make'
  type: string
  default: install_dependencies
  values:
  - install_dependencies
  - build
  - build-noemit 
  - predeploy_build

steps:
- checkout: self
  displayName: 'Checkout'
      
- task: Cache@2
  inputs:
    key: 'yarn | "$(Agent.OS)" | yarn.lock'
    restoreKeys: |
      yarn | "$(Agent.OS)"
      yarn
    path: $(YARN_CACHE_FOLDER)
  displayName: Cache yarn packages

- task: UseNode@1
  inputs:
    version: $(NODE_VERSION)
  displayName: 'Set up Node.js'
  
- bash: |
    npm config list
    echo 'BBBBB'
    ./scripts/init-npm.sh
    cat .npmrc
    echo 'AAAAAA'
    npm config list
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)    
  displayName: 'Init .npmrc file'
  
- script: |
    yarn install --frozen-lockfile
  displayName: 'Install yarn dependencies'

- ${{ if eq(parameters.make, 'build') }}:
  - bash: yarn build
    displayName: 'Build code'

- ${{ if eq(parameters.make, 'build-noemit') }}:
  - bash: yarn build-noemit
    displayName: 'Build-noemit code'

- ${{ if eq(parameters.make, 'predeploy_build') }}:
  - bash: yarn predeploy
    displayName: 'Predeploy build code'
